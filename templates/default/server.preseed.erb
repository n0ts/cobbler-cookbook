#
# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.
#

# Mostly based on the Ubuntu installation guide
# https://help.ubuntu.com/12.10/installation-guide/
#set global $swap_size = $getVar('swap_size', '200%')
#set global $disk_size = $getVar('disk_size', '100%') 
#set global $username  = $getVar('username', '<%= @params[:username] %>')
#set global $user_password  = $getVar('user_password', '<%= @params[:user_password] %>')

# installer common setting
d-i     debian-installer/locale string en_US.UTF-8
d-i     debian-installer/splash boolean false
d-i     console-setup/ask_detect        boolean false
d-i     console-setup/layoutcode        string us
d-i     console-setup/variantcode       string 

# network
d-i     netcfg/choose_interface select auto
d-i     netcfg/get_nameservers  string
d-i     netcfg/get_ipaddress    string
d-i     netcfg/get_netmask      string 255.255.255.0
d-i     netcfg/get_gateway      string 
d-i     netcfg/confirm_static   boolean true

# mirror setting
d-i     mirror/http/countries  select JP
d-i     mirror/http/mirror     select jp.archive.ubuntu.com
d-i     mirror/http/directory  string /ubuntu
<%- if @params[:proxy] %>
d-i     mirror/http/proxy      string http://<%= @params[:proxy] %>:3142
<%- end %>
d-i     mirror/udeb/components multiselect main, restricted, universe

# partitioning
d-i     partman-auto/method string lvm
d-i     partman-lvm/device_remove_lvm boolean true
d-i     partman-md/device_remove_md boolean true
d-i     partman-lvm/confirm boolean true
d-i     partman-md/confirm boolean true
d-i     partman-auto/choose_recipe select lvm-default
d-i     partman-auto-lvm/new_vg_name string vg
d-i     partman-auto-lvm/guided_size string $disk_size
d-i     partman-auto/recipe string \
        1 2 0 ext3 /boot /dev/sda1 \
        .                          \
        1 2 0 lvm - /dev/sda2      \
        .
d-i     partman-auto/expert_recipe string \
$SNIPPET('debian/partition_lvm_default')

d-i     partman/confirm_write_new_label boolean true
d-i     partman/choose_partition        select finish
d-i     partman/confirm                 boolean true
d-i     partman/confirm_nooverwrite     boolean true
d-i     partman-lvm/confirm_nooverwrite boolean true
d-i     partman-md/confirm_nooverwrite  boolean true

# clock
d-i     clock-setup/utc boolean false
d-i     clock-setup/ntp boolean false
d-i     clock-setup/ntp-server  string
d-i     time/zone               string Asia/Tokyo

# base install image
d-i     base-installer/kernel/image string linux-server

# user account 
d-i     passwd/root-login               boolean false
d-i     passwd/make-user                boolean true
d-i     passwd/user-fullname            string
d-i     passwd/username                 string $username
d-i     passwd/user-password-crypted    password $user_password
d-i     passwd/user-uid                 string 
d-i     user-setup/allow-password-weak  boolean true
d-i     user-setup/encrypt-home boolean false
d-i     passwd/user-default-groups      string adm

# security packages
d-i     apt-setup/services-select       multiselect security
d-i     apt-setup/security_host         string security.ubuntu.com
d-i     apt-setup/security_path         string /ubuntu

d-i     debian-installer/allow_unauthenticated  string false
d-i     debian-installer/add-kernel-opts string $kernel_options_post

# upgrade policy
d-i     pkgsel/upgrade          select safe-upgrade
d-i     pkgsel/language-packs   multiselect 
d-i     pkgsel/update-policy    select none
d-i     pkgsel/updatedb         boolean true

# finish installation
d-i     grub-installer/skip               boolean false
d-i     lilo-installer/skip               boolean false
d-i     grub-installer/only_debian        boolean true
d-i     grub-installer/with_other_os      boolean true
d-i     finish-install/keep-consoles      boolean false
d-i     finish-install/reboot_in_progress note 
d-i     cdrom-detect/eject                boolean true
d-i     debian-installer/exit/halt        boolean false
d-i     debian-installer/exit/poweroff    boolean false

# package selection
d-i     pkgsel/include string openssh-server \
                              build-essential \
                              vim zsh ruby1.9.3 sysv-rc-conf \
                              ifenslave bridge-utils acpid

# final installation
d-i     preseed/late_command string chroot /target sh -c ' \
$SNIPPET('debian/post_install_network_config')
$SNIPPET('debian/post_install_fs')
$SNIPPET('debian/post_install_user')
$SNIPPET('debian/post_install_chef')
'

